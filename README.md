# data-hub-helpcentre (aka Data Services Helpcentre)

## Coding Styles

We use the following tools to maintain a consistent coding style

- [black](https://black.readthedocs.io/) - for python code formatting
- [flake8](https://flake8.pycqa.org/en/latest/) - Python code style
- [prettier](https://prettier.io/) - for javascript and sass code formatting

These style rules are enforced by CircleCI *so please check your code locally before pushing changes!*

### Quickly check coding quality locally

The quickest way is the run via docker containers.

    make prettier
    make black
    make flake8

These will create temporary containers install dependencies and run the code formatters

## Local Development - Python

Pre-requisites
- python3
- pip
- docker

#### Animated gif support on macOS

The Wand pip package requires `imagemagick` to be installed for animated gif support

http://docs.wand-py.org/en/0.4.2/guide/install.html

https://github.com/wagtail/wagtail/issues/2505

```bash
brew install imagemagick
```

Configure Python Dev Environment

```
python3 -m venv env
source env/bin/activate

pip install -U pip
pip install -r requirements.txt
```

### Create a local env file

```
cp app/sample.env app/.env
```

Fill in the blanks for `AUTHBROKER`

```
AUTHBROKER_CLIENT_ID=you_can_get_this
AUTHBROKER_CLIENT_SECRET=from_webopp
AUTHBROKER_URL=if_you_have_access
```

### Start the database container


```bash
docker-compose up -d
```

#### Run website locally

```bash
$ source env/bin/activate

$ python app/manage.py migrate

    # ... migrations happen

$ python app/manage.py createsuperuser

    # ... prompts for superuser. Name, email password etc

$ python app/manage.py runserver 0.0.0.0:8000 

    Watching for file changes with StatReloader
    Performing system checks...

    System check identified no issues (0 silenced).
    August 22, 2019 - 13:23:29
    Django version 2.2.4, using settings 'helpcentre.settings.dev'
    Starting development server at http://0.0.0.0:8000/
    Quit the server with CONTROL-C.

```

## Building the front end styles


## 1. Using `yarn` (recommended)

### Pre-requisites
- [Node.js](https://nodejs.org/)
- [yarn](https://yarnpkg.com/)


```bash
$ yarn
$ yarn sass

[13:34:16] Using gulpfile /******/gulpfile.js
[13:34:16] Starting 'default'...
[13:34:16] Starting 'sass'...
[13:34:16] Starting 'clean'...
[13:34:16] Finished 'clean' after 18 ms
[13:34:16] Starting 'sass:compile'...
[13:34:16] Finished 'sass:compile' after 204 ms
[13:34:16] Finished 'sass' after 226 ms
[13:34:16] Starting 'copy-govuk-assets'...
[13:34:16] Finished 'copy-govuk-assets' after 48 ms
[13:34:16] Starting 'copy-govuk-js'...
[13:34:16] Finished 'copy-govuk-js' after 5.38 ms
[13:34:16] Finished 'default' after 283 ms
Done in 0.71s.

```

## 2. Build styles using yarn within a docker container

This will leave a `node_modules` directory with `root:root` permissions in your project folder which you'll need to `sudo rm` to remove.

Also any assets generated by the `yarn sass` command will also have `root:root` permissions. `sudo chown -R $USER:$USER app/helpcentre/static/` may help ;)


```bash
$ docker run -it --rm --name frontend -v "$(pwd):/app" node:10 bash -c 'cd /app && yarn && yarn sass'     

```



# Issues with local dev

## macOs

### Unable to install pip dependencies

```
writing manifest file 'pip-egg-info/psycopg2.egg-info/SOURCES.txt'

    Error: pg_config executable not found.

    pg_config is required to build psycopg2 from source.  Please add the directory
```

Try 

    brew install postgresql


## Ubuntu > 18

https://stackoverflow.com/a/12037133

```
    writing manifest file '/tmp/pip-install-d7flps2p/psycopg2/pip-egg-info/psycopg2.egg-info/SOURCES.txt'
    
    Error: pg_config executable not found.

```

Try

```
    sudo apt install libpq-dev
```
